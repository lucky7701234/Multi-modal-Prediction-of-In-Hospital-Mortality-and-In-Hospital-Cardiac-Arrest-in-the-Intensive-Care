with my_main as (  with vital_main as  (with main as ( select  patient.patientunitstayid,max(diagnosisoffset) as  diagnosisoffset ,max(diagnosisoffset)-1440 as minoff from `physionet-data.eicu_crd.patient` as patient
left join  `physionet-data.eicu_crd.diagnosis` as diagnosis on patient.patientunitstayid=diagnosis.patientunitstayid

where 1=1
and  Diagnosisoffset >=1440 
and icd9code='427.5, I46.9'
and patient.patientunitstayid in
(
150933,
155041,
158455,
158937,
162897,
165286,
166054,
168134,
172465,
173196,
173983,
183374,
191400,
195726,
197253,
197601,
198373,
199509,
203034,
203500,
206442,
207404,
207517,
208334,
212096,
213563,
222042,
223427,
226933,
228234,
228732,
234371,
234627,
234964,
236713,
237122,
238395,
240799,
250724,
251885,
252287,
252908,
252954,
256864,
260078,
260882,
261520,
267666,
267869,
270217,
278445,
285992,
286108,
289481,
292001,
293583,
294603,
297292,
299527,
300361,
300435,
302982,
307552,
311803,
312221,
316454,
317597,
318858,
325631,
330467,
335499,
339963,
344265,
349040,
355962,
362606,
367300,
370797,
376239,
382415,
385354,
386616,
389324,
397127,
398849,
403964,
405994,
409050,
411957,
418383,
422556,
425297,
425299,
430527,
441947,
442593,
446448,
450349,
457060,
459767,
465989,
466989,
468403,
473488,
473722,
476097,
483708,
489405,
493267,
501023,
504217,
510840,
512091,
518162,
525422,
526324,
528316,
528317,
532178,
533750,
536088,
538721,
539163,
539436,
539867,
546750,
549524,
550167,
550552,
551418,
552004,
554522,
560046,
560615,
560956,
561992,
564112,
564875,
568589,
569237,
572038,
573015,
573051,
573889,
577628,
579301,
579844,
581504,
581559,
583864,
585737,
586354,
588935,
589042,
591927,
595264,
595633,
597059,
599278,
599898,
603903,
606643,
608028,
608969,
610901,
611089,
615963,
617978,
618283,
618956,
620292,
622178,
622726,
622910,
626786,
628882,
629279,
631445,
636165,
636801,
643783,
647473,
647999,
653119,
655719,
655913,
659727,
663221,
663234,
664330,
664415,
665391,
669431,
669439,
670473,
674323,
678714,
679534,
681525,
686437,
687674,
689518,
690111,
692059,
698218,
698760,
699129,
699303,
699332,
699797,
700032,
701883,
703457,
713588,
713812,
717659,
720811,
722930,
729922,
731745,
732688,
741597,
741914,
742225,
743280,
745126,
751549,
752374,
752818,
755170,
756540,
756599,
759031,
760472,
766955,
767465,
772670,
773733,
774874,
777351,
784451,
784487,
787147,
788333,
788887,
789796,
790081,
799502,
800856,
800936,
803058,
807098,
809818,
810093,
814717,
817006,
819668,
820527,
823258,
828476,
829667,
831083,
832193,
832954,
836139,
836215,
836541,
837709,
840047,
840854,
842140,
843976,
845388,
845749,
850663,
850679,
850903,
854880,
857375,
857826,
858760,
859606,
868303,
872808,
873441,
874559,
875413,
875553,
875693,
880757,
881703,
884706,
884841,
891511,
892820,
896231,
896778,
899435,
899583,
903751,
903992,
909905,
911730,
912999,
913052,
917634,
919705,
920723,
920941,
923423,
924059,
924084,
924771,
925012,
931198,
931238,
932135,
934705,
939463,
939515,
942809,
944641,
944840,
945149,
945476,
948467,
948832,
952482,
953313,
953958,
955182,
958430,
958543,
960606,
960679,
960855,
961040,
961627,
962061,
962705,
963711,
966721,
968004,
969543,
972737,
974782,
977607,
978109,
978542,
979733,
988209,
1000301,
1000586,
1001183,
1003225,
1006983,
1012236,
1012459,
1013390,
1014430,
1014569,
1014893,
1016211,
1019315,
1019789,
1020341,
1022340,
1023205,
1024914,
1027209,
1032340,
1033198,
1036751,
1040928,
1043866,
1044252,
1047339,
1051075,
1051707,
1053127,
1053383,
1055246,
1056213,
1056417,
1057910,
1058426,
1059133,
1064676,
1064907,
1065888,
1068532,
1071143,
1071712,
1074781,
1074862,
1077136,
1078046,
1079420,
1079798,
1082492,
1083001,
1083839,
1084173,
1085425,
1086811,
1087272,
1087864,
1087948,
1088687,
1089444,
1091743,
1093226,
1093290,
1093487,
1095686,
1097725,
1097780,
1099555,
1105394,
1106223,
1108966,
1109263,
1109790,
1112529,
1114101,
1115561,
1115642,
1115818,
1116127,
1116802,
1117431,
1117569,
1118997,
1123205,
1123223,
1123746,
1126788,
1127566,
1128329,
1129623,
1129655,
1129847,
1132889,
1135942,
1137611,
1138618,
1140563,
1141677,
1149486,
1151189,
1155391,
1159481,
1162267,
1165157,
1165793,
1167759,
1171139,
1174015,
1175466,
1175725,
1184082,
1184408,
1205322,
1207531,
1207719,
1210567,
1225956,
1227621,
1258392,
1260260,
1265634,
1294577,
1296451,
1317379,
1319680,
1320048,
1323112,
1330498,
1330802,
1331419,
1333296,
1348139,
1349251,
1360607,
1434178,
1443440,
1448860,
1456729,
1471522,
1473108,
1474647,
1477208,
1477496,
1493237,
1496974,
1512287,
1522898,
1530832,
1531835,
1540397,
1542334,
1544346,
1547603,
1548928,
1554667,
1555249,
1555931,
1556021,
1557625,
1557908,
1558731,
1558775,
1560694,
1560743,
1563220,
1563627,
1564271,
1564290,
1565417,
1565628,
1566042,
1566889,
1567120,
1568401,
1569697,
1570408,
1570797,
1571063,
1571182,
1571320,
1571334,
1571641,
1572832,
1573229,
1574236,
1574333,
1575252,
1575341,
1577930,
1580620,
1580967,
1581828,
1582325,
1582359,
1586525,
1586894,
1587430,
1588235,
1588733,
1589401,
1590534,
1590725,
1590979,
1591162,
1591808,
1591942,
1592555,
1593247,
1723876,
1724369,
1730180,
1730909,
1731887,
1733084,
1738944,
1741570,
1745443,
1748551,
1751435,
1752174,
1757237,
1763015,
1763143,
1772612,
1775000,
1778257,
1787002,
1788142,
1789067,
1791782,
1792823,
1805575,
1806836,
1809093,
1819332,
1821707,
1823863,
1824175,
1824598,
1826965,
1843759,
1844034,
1849722,
1855611,
1855900,
1856875,
1859063,
1964439,
1993470,
2082124,
2105385,
2111705,
2120961,
2134250,
2152131,
2160571,
2172997,
2196212,
2222446,
2228747,
2237571,
2251078,
2254391,
2259881,
2261967,
2301646,
2310856,
2326265,
2353842,
2485662,
2490668,
2572995,
2573078,
2574810,
2576087,
2581769,
2584289,
2587289,
2589865,
2590699,
2597626,
2598510,
2598565,
2602411,
2606945,
2608505,
2614813,
2620499,
2624082,
2626069,
2626356,
2626456,
2629821,
2633529,
2637396,
2637605,
2638215,
2644507,
2645205,
2672303,
2680216,
2682217,
2684582,
2686626,
2688156,
2688596,
2695979,
2700636,
2701329,
2701879,
2707202,
2709857,
2733619,
2737060,
2744216,
2745043,
2745278,
2747847,
2760516,
2761780,
2762516,
2776961,
2785754,
2786898,
2790859,
2791099,
2794140,
2796012,
2800355,
2802513,
2816106,
2817512,
2822876,
2832188,
2835478,
2835994,
2836136,
2836894,
2842730,
2846197,
2850380,
2850613,
2854174,
2864465,
2864857,
2874661,
2881772,
2882095,
2893461,
2898420,
2933781,
2956858,
3000794,
3004537,
3008068,
3009131,
3012604,
3013363,
3015193,
3015450,
3015722,
3020202,
3022244,
3022319,
3023604,
3024118,
3024841,
3025965,
3027023,
3029511,
3031006,
3031015,
3031284,
3032788,
3033963,
3034037,
3038834,
3039810,
3040502,
3041365,
3043701,
3045315,
3045613,
3050952,
3052830,
3054241,
3054448,
3055199,
3060594,
3061634,
3062256,
3063628,
3071766,
3073181,
3074474,
3075433,
3075588,
3076811,
3077775,
3079021,
3079838,
3080400,
3080496,
3081132,
3083659,
3085269,
3085904,
3087656,
3089484,
3091075,
3091229,
3094214,
3095203,
3098663,
3100578,
3103378,
3104291,
3106843,
3107721,
3107953,
3109000,
3115403,
3115807,
3115913,
3116772,
3118901,
3122789,
3124446,
3126514,
3128945,
3131134,
3132859,
3133314,
3133590,
3135634,
3137428,
3138546,
3139305,
3139448,
3139546,
3141749,
3143768,
3143888,
3144249,
3144369,
3144807,
3145760,
3146161,
3146897,
3146941,
3147915,
3149308,
3149372,
3150021,
3150806,
3151780,
3152744,
3154062,
3154659,
3155252,
3156864,
3157810,
3157901,
3158370,
3159210,
3160464,
3161370,
3163481,
3173980,
3181349,
3190670,
3205421,
3205635,
3206079,
3206720,
3207465,
3207929,
3210953,
3213427,
3214512,
3219988,
3220580,
3220985,
3223015,
3224392,
3226650,
3226955,
3227286,
3230955,
3232254,
3234234,
3234719,
3235231,
3235531,
3235941,
3236184,
3236528,
3237818,
3237997,
3238367,
3239486,
3239721,
3240660,
3240820,
3241912,
3243869,
3243931,
3244177,
3244483,
3246123,
3327105,
3327171,
3327311,
3328658,
3328859,
3329043,
3329958,
3331258,
3331399,
3331851,
3331988,
3332609,
3333890,
3334393,
3335187,
3335839,
3335982,
3336045,
3336056,
3336068,
3336289,
3336342,
3336434,
3336438,
3336460,
3336629,
3337289,
3337921,
3339374,
3339535,
3339736,
3340400,
3340694,
3342213,
3342679,
3343157,
3343216,
3343727,
3344363,
3344534,
3344645,
3344801,
3344995,
3345211,
3345395,
3345882,
3346177,
3346553,
3346733,
3346793,
3347010,
3348974,
3349586,
3351806,
3352123,
3353194,
3353251
)

group by patientunitstayid
 )

select main.*,
case when observationoffset>=diagnosisoffset -(1*60) then 1
when observationoffset>=diagnosisoffset -(2*60) then 2
when observationoffset>=diagnosisoffset -(3*60) then 3
when observationoffset>=diagnosisoffset -(4*60) then 4
when observationoffset>=diagnosisoffset -(5*60) then 5
when observationoffset>=diagnosisoffset -(6*60) then 6
when observationoffset>=diagnosisoffset -(7*60) then 7
when observationoffset>=diagnosisoffset -(8*60) then 8
when observationoffset>=diagnosisoffset -(9*60) then 9
when observationoffset>=diagnosisoffset -(10*60) then 10
when observationoffset>=diagnosisoffset -(11*60) then 11
when observationoffset>=diagnosisoffset -(12*60) then 12
when observationoffset>=diagnosisoffset -(13*60) then 13
when observationoffset>=diagnosisoffset -(14*60) then 14
when observationoffset>=diagnosisoffset -(15*60) then 15
when observationoffset>=diagnosisoffset -(16*60) then 16
when observationoffset>=diagnosisoffset -(17*60) then 17
when observationoffset>=diagnosisoffset -(18*60) then 18
when observationoffset>=diagnosisoffset -(19*60) then 19
when observationoffset>=diagnosisoffset -(20*60) then 20
when observationoffset>=diagnosisoffset -(21*60) then 21
when observationoffset>=diagnosisoffset -(22*60) then 22
when observationoffset>=diagnosisoffset -(23*60) then 23
when observationoffset>=diagnosisoffset -(24*60) then 24
else 0 end as timeLV
,  observationoffset,heartRate as vHR, respiration as vRR,  systemicSystolic as vsbp, systemicDiastolic as vdbp, systemicMean as vmbp,saO2 as vspo2 from main
left join `physionet-data.eicu_crd.vitalperiodic` as vitalPeriodic on main.patientunitstayid=vitalPeriodic.patientunitstayid and vitalPeriodic.observationOffset<main.diagnosisoffset and  vitalPeriodic.observationOffset>=main.minoff

where 1=1
)

select patientunitstayid,timeLV, max(vHR) as max_vHR,min(vHR) as min_vHR,max(vRR) as max_RR,min(vRR) AS min_RR,min(vsbp) as vsbp,min(vdbp) as vdbp,min(vmbp) as vmbp,min(vspo2) as vspo2 from vital_main

where 1=1

group by patientunitstayid,timeLV

)

select patientunitstayid,timeLV, case when min_vHR>=80 then max_vHR else min_vHR end as vHR , case when min_RR>=12 then max_RR else min_RR end as vRR ,vsbp,vdbp,vmbp,vspo2 from my_main
where 1=1

order by patientunitstayid,timeLV  